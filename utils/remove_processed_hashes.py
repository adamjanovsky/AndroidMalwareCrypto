import json
import argparse
import csv

# csv is in format sha256, sha1, md5, dex_date, apk_size, pkg_name, vercode, vt_detection, vt_scan_date, dex_size, markets
# json contains sha256 as key
USED_HASH = "sha256"

def main() -> None:

    parser = argparse.ArgumentParser(description="Remove processed hashes from csv")
    parser.add_argument(
        "json_path",
        metavar="JSON_PATH", 
        type=str, 
        help="path to processed records in json"
    )
    parser.add_argument(
        "csv_input_path",
        metavar="CSV_INPUT_PATH", 
        type=str, 
        help="path to androzoo csv"
    )
    parser.add_argument(
        "csv_output_path",
        metavar="CSV_OUTPUT_PATH", 
        type=str, 
        help="path to where to store androzoo csv without hashes in json_path"
    )
    args = parser.parse_args()
    with open(args.json_path) as f:
        print("Loading hashes of processed keys.")
        processed_hashes = set(json.load(f).keys())
    with open(args.csv_input_path) as in_f, open(args.csv_output_path, "w") as out_f:
        print("Filtering csv.")
        filtered = 0
        csv_reader = csv.DictReader(in_f)
        csv_writer = csv.DictWriter(out_f, csv_reader.fieldnames)
        csv_writer.writeheader()
        for row in csv_reader:
            if row[USED_HASH].lower() not in processed_hashes:
                csv_writer.writerow(row)
            else:
                filtered += 1
        print(f"Filtered {filtered} hashes.")



if __name__ == "__main__":
    main()