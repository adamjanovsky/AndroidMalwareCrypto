from androguard.core.bytecodes.apk import APK
from androguard.core.bytecodes.dvm import DalvikVMFormat
from androguard.core.analysis.analysis import Analysis
from androguard.decompiler.decompiler import DecompilerJADX
import lzma
import pickle
from stopit import TimeoutException
from androidcrypto.constants import DecompileException


def decompile_worker(sample, task_config):
    try:
        a = APK(sample.apk_path)
        d = DalvikVMFormat(a)
        dx = Analysis(d)
        d.set_decompiler(DecompilerJADX(d, dx, jadx=task_config.jadx_path))
        if len(dx.classes) > 0:
            with lzma.open(sample.dx_path, 'wb') as handle:
                pickle.dump(dx, handle)
        else:
            raise DecompileException
    except Exception as e:
        if isinstance(e, TimeoutException):
            raise
        else:
            raise DecompileException

