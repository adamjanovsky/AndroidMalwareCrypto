from androguard.core.bytecodes.apk import APK
from androguard.core.bytecodes.dvm import DalvikVMFormat
from androguard.core.analysis.analysis import Analysis
from androguard.decompiler.decompiler import DecompilerJADX
from stopit import TimeoutException
from androidcrypto.constants import DecompileException
import logging

logging.getLogger('androguard').setLevel(logging.CRITICAL)


def decompile_worker(sample, task_config):
    try:
        a = APK(sample.apk_path)
        d = DalvikVMFormat(a)
        sample.dx_object = Analysis(d)
        d.set_decompiler(DecompilerJADX(d, sample.dx_object, jadx=task_config.jadx_path))
        if len(sample.dx_object.classes) > 0:
            sample.dump_dx_to_file()
            sample.dx_object = None
        else:
            logging.warning(f'Aborting on decompilation due to 0 classes present in {sample.sha256}')
            raise DecompileException
    except Exception as e:
        if isinstance(e, TimeoutException):
            raise
        else:
            logging.warning(f'Aborting decompilation on {sample} due to: {e}')
            raise DecompileException

