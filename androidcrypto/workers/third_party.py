import json
import subprocess
from stopit import TimeoutException
from androidcrypto.constants import ThirdPartyException


def third_party_worker(sample_record, literadar_path, crypto_libs):
    try:
        tmp_filepath = sample_record['metadata']['third_party_tmp_path']
        string_to_call = 'python2 ' + literadar_path + ' ' + sample_record['metadata']['apk_path'] + ' ' + tmp_filepath
        third_party_packages = []
        found_crypto_libs = []

        subprocess.run(string_to_call, shell=True, check=True)
        with open(tmp_filepath, 'r') as handle:
            data = json.load(handle)

        for lib in data:
            third_party_packages.append(lib['Package'])
            if crypto_libs is not None:
                for x in crypto_libs:
                    if x in lib['Standard Package']:
                        found_crypto_libs.append(lib['Standard Package'])

        sample_record['third_party_crypto_libs'] = found_crypto_libs
        sample_record['third_party_libs'] = third_party_packages

    except Exception as e:
        if isinstance(e, TimeoutException):
            raise
        else:
            raise ThirdPartyException
