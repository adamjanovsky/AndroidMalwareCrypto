import core.helpers as helpers
import core.analyzer as analyzer
import pyjadx
import yaml
import os
from pathlib import Path


class ExperimentRunner:
    def __init__(self, config_path, neptune_token):
        self.config_path = config_path
        self.neptune_token = neptune_token

        self.experiment_name = None
        self.input_path = None
        self.dataset_paths = []
        self.output_path = None

        self.dataset_name = 'No_dataset_specified'

    def run(self):
        with open(self.config_path) as stream:
            config = yaml.load(stream, Loader=yaml.FullLoader)

            self.input_path = Path(config['input_path'])
            self.output_path = Path(config['output_path'])
            self.dataset_name = config['dataset_name']
            self.dataset_paths = config['dataset_paths']

            for task in config['task']:
                if task == 'deobfuscate':
                    for dset in self.dataset_paths:
                        exp_results_filepath = os.path.join(self.output_path, 'base64_strings_' + self.dataset_name + '.txt')
                        self.decode_base64(dset, exp_results_filepath)

                elif task == 'word_stats':
                    self.compute_word_statistics(self.input_path, self.output_path, config['word_stats']['words'], False)


    @staticmethod
    def compute_word_statistics(dir_to_search, output_path, words, count_imports=True):
        jadx = pyjadx.Jadx()
        apks_to_search = helpers.find_all_files_with_extension(dir_to_search, 'apk')

        task = analyzer.ComputeStringStatistics(jadx, apks_to_search, output_path, words, count_imports)
        task.run()

    @staticmethod
    def decode_base64(dir_to_search, output_path):
        with helpers.suppress_stdout():
            jadx = pyjadx.Jadx()
            apks_to_search = helpers.find_all_files_with_extension(dir_to_search, 'apk')

            task = analyzer.DeobfuscateBase64(jadx, apks_to_search, output_path)
            task.run()
