import pandas as pd
import numpy as np
import os


class Task:
    pass


class ComputeStringStatistics(Task):
    def __init__(self, jadx, apks_to_search, output_path, strings_to_search=None):
        self.jadx = jadx
        self.strings_to_search = strings_to_search
        self.apks_to_search = apks_to_search
        self.csv_filename = os.path.join(output_path, 'results.csv')

        self.occurrences_counter = pd.DataFrame(0, index=np.arange(len(self.apks_to_search)), columns=self.strings_to_search)
        self.occurrences_counter['file'] = [os.path.basename(x) for x in self.apks_to_search]

    def run(self):
        for i, apk in enumerate(self.apks_to_search):
            self.count_occurrences_in_code(apk, i)

        self.occurrences_counter.to_csv(self.csv_filename, index=False)

    def count_occurrences_in_code(self, apk, i):
        decompiler = self.jadx.load(apk)
        for cls in decompiler.classes:
            for line in cls.code.split('\n'):
                for s in self.strings_to_search:
                    if s in line:
                        self.occurrences_counter.at[i, s] += 1

