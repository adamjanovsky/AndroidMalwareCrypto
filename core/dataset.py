import core.constants as constants
from checksumdir import dirhash
import os
import logging
import yaml


class Dataset:
    """
    A dataset is expected to be stored in a folder with the following structure:
    root
    |- meta.yml (metafile containing information about the dataset
    |- Data (arbitrary subfolders with apks)
    ---| - apk1
    ---| - Subfolders
    If no sha-digest is set in meta.yml, new is computed from the Data folder.
    It is however assumed that once hash is computed, it is not being changed - we should rethink this
    TODO: Rethink the hash paradigm above
    """
    def __init__(self, root_path):
        self.root_path = root_path
        self.data_path = os.path.join(root_path, constants.DATA_DIRNAME)

        self.sha_digest = None
        self.n_apks = 0
        self.name = None
        self.description = None

        self.apks = []
        self.parse_meta()

    def parse_meta(self):
        """
        Parses the meta.yml dataset file and constructs a Dataset object out of it.
        :return:
        """
        meta_path = os.path.join(self.root_path, constants.META_FILENAME)
        if not os.path.isfile(meta_path):
            logging.info(f'Failed to load the dataset, meta file missing.')
            return
        with open(meta_path, 'r') as meta_file:
            config = yaml.load(meta_file, Loader=yaml.FullLoader)
            self.name = config['dataset_name']
            self.description = config['description']

            self.sha_digest = None if config['sha_256'] == 'None' else config['sha_256']
            if self.sha_digest is None:
                self.sha_digest = dirhash(self.data_path, 'sha256')
                config['sha_256'] = self.sha_digest

            self.n_apks = config['n_apks']

            to_update = False
            if self.n_apks == 0:
                to_update = True
            for root, dir, files in os.walk(self.data_path):
                dir_apks = [os.path.join(root, f) for f in files if f.endswith('apk')]
                if to_update:
                    self.n_apks += len(dir_apks)
                self.apks.extend(dir_apks)
            config['n_apks'] = self.n_apks

        with open(meta_path, 'w') as meta_file:
            yaml.dump(config, meta_file)

