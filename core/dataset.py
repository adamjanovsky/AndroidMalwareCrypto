import core.constants as constants
from checksumdir import dirhash
import os
import logging
import yaml


class Dataset:
    def __init__(self, root_path):
        self.root_path = root_path
        self.data_path = os.path.join(root_path, constants.DATA_DIRNAME)

        self.sha_digest = None
        self.n_apks = 0
        self.name = None
        self.description = None

        self.apks = []
        self.parse_meta()

    def parse_meta(self):
        meta_path = os.path.join(self.root_path, constants.META_FILENAME)
        if not os.path.isfile(meta_path):
            logging.info(f'Failed to load the dataset, meta file missing.')
            return
        with open(meta_path, 'r') as meta_file:
            config = yaml.load(meta_file, Loader=yaml.FullLoader)
            self.name = config['dataset_name']
            self.description = config['description']

            self.sha_digest = None if config['sha_256'] == 'None' else config['sha_256']
            if self.sha_digest is None:
                self.sha_digest = dirhash(self.data_path, 'sha256')
                config['sha_256'] = self.sha_digest

            self.n_apks = config['n_apks']

            for root, dir, files in os.walk(self.data_path):
                dir_apks = [os.path.join(root, f) for f in files if f.endswith('apk')]
                self.n_apks += len(dir_apks)
                self.apks.extend(dir_apks)
            config['n_apks'] = self.n_apks

        with open(meta_path, 'w') as meta_file:
            yaml.dump(config, meta_file)

