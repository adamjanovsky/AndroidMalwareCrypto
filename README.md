# AndroidMalwareCrypto

This tool allows for an analysis of cryptographic API in Android applications. All knowledge regarding this project shall reside in the readme file if not stated otherwise. The `AndroidMalwareCrypto` tool was designed for the analysis of malicious datasets, but can be used for any dataset of Android APKs. The objective of the tool is to automatically decompile whole dataset, collect, and analyze the distribution of cryptographic API in the APKs. The process of collection can be handled by the analyst in a one-click fashion. Another one-click is required for the analysis to evaluate this collection, in order to get a report about cryptographic API usage in the datset. 

## Install 

The project is written and tested on Python 3.8. Apart from bare Python, the tool requires integration with two patched repositories (see below). Due to complex installation process, we offer a Docker image of our tool that can be run interactively. In addition, the [Dockerfile](docker/Dockerfile) contains consise instructions on how to install our tool on vanilla Ubuntu. 

### Run with Docker

1. Install [Docker](https://docs.docker.com/get-docker/) if you havenâ€™t already

2. Pull the image with `docker pull adamjanovsky/cryptomlw:latest`
3. Run the image interactively with `docker run -it adamjanovsky/cryptomlw`
4. Now you can run your experiments, e.g. with 
```
cd AndroidMalwareCrypto \
&& python3 ./cli_process.py sample_experiment/configs/dataset_processing/config_processing.yml
```

5. You can then view the output of the experiment in `/home/user/AndroidMalwareCrypto/sample_experiment/dataset/`

It is recommended that you set-up a [Docker volume](https://docs.docker.com/storage/volumes/) outside of the container and use it in combination with the image to produce the results into your local folder on your computer.

Note: To make most of our tool, you need to have [neptune.ai](neptune.ai) token and [Androzoo](https://androzoo.uni.lu/) token, see [Dependencies](#dependencies) for more. 

## Architecture

The tool divides the analysis into two major steps. The first phase is called an *experiment*, the second phase concerns *evaluation* of the experiment. 

### 1. Experiment

The experiment is fully defined by an experiment config, [see example](https://github.com/adamjanovsky/AndroidMalwareCrypto/blob/master/sample_experiment/experiment_output/config.yml). Five major task may be performed as a part of the conducted experiment:

1. Download a dataset of APKs to work with (`download` task). Optionally, a dataset can be [loaded from disk](https://github.com/adamjanovsky/AndroidMalwareCrypto#how-to-work-with-datasets), skipping this task.
2. Decompile the APKs into the Androguard analysis objects (`decompile` task).
3. Analyze the usage of third-party packages in the APK using own fork of LiteRadar (`third_party_libs` task).
4. Evaluate the usage of cryptographic API from the Androguard dx file (`evaluate` task).
5. Possibly label the sample with its malware family and type label, acquired by [Euphony](https://core.ac.uk/download/pdf/83926508.pdf) (`label` task)

This list also sets the chronological order of the actions that can happen during an experiment, e.g. step 4 cannot be done before step 2, etc. For your experiment, you can choose any subset of the tasks to be performed, e.g. 1,2,3 or just 3,4. Some of the tasks may be dependent on some external tools to run properly. Please make sure you have the integration covered according to the table below

| Task               | Tool to integrate                                                                                                | Can be turned off           |
| ------------------ | ---------------------------------------------------------------------------------------------------------------- | --------------------------- |
| All tasks          | [Neptune.ml](https://github.com/adamjanovsky/AndroidMalwareCrypto#neptune-integration)                           | Yes,  in configuration file |
| `download`         | [Androzoo dataset](https://github.com/adamjanovsky/AndroidMalwareCrypto#androzoo-integration)                    | Yes, skip the task          |
| `decompile`        | [Patched Androguard, jadx](https://github.com/adamjanovsky/AndroidMalwareCrypto#androguard-and-jadx-integration) | You can decompile with DAD  |
| `third_party_libs` | [Literadar](https://github.com/adamjanovsky/AndroidMalwareCrypto#literadar-integration)                          | Yes, skip the task          |
| `evaluate`         | No tool needed                                                                                                   | -                           |
| `label`            | [Euphony csv files](https://github.com/adamjanovsky/AndroidMalwareCrypto#euphony-integration)                    | Yes, skip the task          |


Also, the experiment works with multiple apks concurrently, performing all five tasks (or their subset) chronologically.  Each of the tasks has its own configuration options, all residing in the experiment configuration file. All results are then stored in a single json file called `records.json` held in the dataset folder.

### 2. Evaluation

During the evaluation, the tool collects one ore multiple experiment results and produces a comprehensive report about cryptographic API usage in the dataset(s). If multiple experiments are supplied, it should be guaranteed that all samples are from the same year inside the respective experiments. Otherwise, the temporal evolution could draw faulty conclusions. 

## Usage

To run an experiment, first you have to create a configuration file (from [template](https://github.com/adamjanovsky/AndroidMalwareCrypto/blob/master/sample_experiment/experiment_output/config.yml)) for the experiment. We explain how to fill the configuration file in [Sample experiment](https://github.com/adamjanovsky/AndroidMalwareCrypto#sample-experiment). Then, run

```
androidcrypto <path_to_yaml_configuration_file> -n <optionally a base64 encoded Neptune.ai token> -a <optiionally an Androzoo API token>
```

To evaluate the experiment, run

```
python3 androidcrypto/evaluate/evaluator.py <path_to_folder_with_experiment> <path_to_folder_where_to_store_the_report> <path_to_api_definition> -s -f -e
```
where the flags `-s -f -e` are optional. `-s` specifies whether to show the basic characteristics to stdout. `-f` specifies, whether to store the basic characteristics into a file (in the report folder), `-e` specifies whether to plot the distribution of euphony labels.

After doing both stages, you should see a report about cryptographic API usage in the path that you specified as a command-line parameter. See the [Sample experiment](https://github.com/adamjanovsky/AndroidMalwareCrypto#sample-experiment) for a toy example.

### Sample experiment

We have prepared a toy experiment that enables you to play with various parameters of our tool. In order to run the experiment, you have to make the whole tool running as a prerequisite (only integration with LiteRadar is required). The toy experiment contains 10 samples filled with various cryptographic API categories and the report should therefore be considerably rich (taking into account that 10 samples were analyzed.)

The config file for the experiment can be found at

```
AndroidMalwareCrypto/sample_experiment/experiment_output/config.yml
```

and following keys have to be supplied:

```
dataset_path: '/navigate/to/AndroidMalwareCrypto/sample_experiment/dataset'
literadar_path: '/navitage/to/LiteRadar/LiteRadar/literadar.py'
```

Then, run `androidcrypto` (and evaluation script) according to [usage](https://github.com/adamjanovsky/AndroidMalwareCrypto#susage). The tool should produce output similar to the one in [Sample report](https://github.com/adamjanovsky/AndroidMalwareCrypto/s) folder.

## Dependencies

### Neptune integration

The project is capabple of being fully integrated with [Neptune.ai](Neptune.ai). This allows the user to track all experiments performed with the project. Most notably, it is possible to monitor a progress of long-running experiment. 

![Neptune.ai monitoring tool](neptuneai.png)

If you wish to integrate Neptune.ai with this tool, you simply have to register at [Neptune.ai](neptune.ai) and specify the following options in the configuration file:

```
is_being_logged: True # If you want to log in Neptune.ai or not.
neptune_project_name: 'Team/YourProjectName' # Name of project in the Neptune.ai
experiment_name: 'MyLittleExperiment' # Name of experiment for the Neptune.ai
```

If you do not want to integrate with Neptune.ai, simply put `is_being_logged: False` to the experiment config and should be safe to go.

### Androzoo integration

Apart from providing your own dataset, this tool is capable of leveraing the [Androzoo dataset](https://androzoo.uni.lu/) to download malicious APKs directly from their database. In order to be able to create datasets from Androzoo, you have to to register in the [Androzoo service](https://androzoo.uni.lu/access) and obtain your API key. After that, you have to download the [list of APKs in the Androzoo](https://androzoo.uni.lu/lists) (csv) and possibly shuffle the lines of it (if you want to ensure random sampling). After doing so, you can integrate Androzoo with the tool in the configuration file by specifying the option

```
csv_path: '/path/to/androzoo/androzoo_shuffled.csv' # path to your csv file of Androzoo
```

Also, you have to include the Androzoo token as a command-line parameter when running `androidcrypto`. See [usage](https://github.com/adamjanovsky/AndroidMalwareCrypto#usage). For more details about dataset handling, see ["How to work with datasets"](https://github.com/adamjanovsky/AndroidMalwareCrypto/tree/master#how-to-work-with-datasets). 

### Androguard and Jadx integration

We decided to use [Jadx decompiler](https://github.com/skylot/jadx) instead of the Androguard's default DAD. That is because Jadx decompiler, from our experience, produces cleaner source code. However, the current version of Androguard contains a bug yet to be resolved that prevents from using Jadx. For that reason, you should install [patched (forked) version of Androguard](https://github.com/adamjanovsky/androguard). 

Naturally, you need to have [Jadx](https://github.com/skylot/jadx) installed and present in a path. To navigate `androidcrypto` to your `jadx` decompiler, specify the following option in the configuration file:

```
jadx_path: '/path/to/jadx/build/jadx/bin/jadx' # Path to the jadx binary in your system, keep it 'jadx' if jadx is in your system path
```

### Literadar integration

Detection of third-party libraries usage uses the fork of [LiteRadar](https://github.com/adamjanovsky/LiteRadar) script under the hood. That script is being executed as python2 process, so you need to have python2 (2.7) functionable as well on your computer. Make sure to specify the path to the LiteRadar binary in the experiment config using the following parameter:

```
literadar_path: '/path/to/LiteRadar/LiteRadar/literadar.py' # Path to the LiteRadar python2 script
```

### Euphony integration

Possibly, you can also let [Euphony](https://core.ac.uk/download/pdf/83926508.pdf) label your malware samples with family names and types. Note that this functionality will probably fail when applied outside of the Androzoo dataset (more precisely it will result in `None` labels). 

In order to integrate Euphony with `androidcrypto`, you have to download the labels from [Androzoo website](https://androzoo.uni.lu/labels) and navigate the `androidcrypto` to these files using the following configuration keys:

```
euphony_names_path: '/path/to/euphony/names_proposed.json'
euphony_types_path: '/path/to/euphony/types_proposed.json'  
```

## How to work with datasets

There are two ways of supplying the dataset for analysis: 

1. Load own APKs from a disk.
2. Command the `download` task to provide a dataset from Androzoo. 

The folder [sample_dataset](https://github.com/adamjanovsky/AndroidMalwareCrypto/tree/master/sample_experiment/dataset) shows the form of a dataset (and is used in the sample experiment). The form of the folder is shown in the listing below. It should be noted that the parameters for the Androzoo sampling (how many samples to download, should they be malicious?, etc.) can be found in the `download` task configuration in the configuration file. 

```
DatasetFolder/
+-- meta.yml  # Store basic information about the dataset, you don't have to provide this
+-- records.json # Stores extracted data for each of the APKs, will get created automatically
|     +-- data/
|     +-- /apk
       |    +-- all_the_apk_files
|     +-- /dx
       |    +-- (possibly, dx files will be stored here), you don't have to provide this
```

## License

This project is licensed under the [MIT license](https://en.wikipedia.org/wiki/MIT_License).

## Project status & Contributing

We consider this project to be complete on the Android platform. Still, we plan to continue our exploration of cryptography in malware on other platforms. If you think of helping us with these efforts, you discovered a bug, or perhaps you want to enhance the functionality of `androidcrypto`, please do not hessiate to open an issue or [contact the authors](https://github.com/adamjanovsky/AndroidMalwareCrypto#authors). 

## Authors

The study is a joint work of [Center for Research on Cryptography and Security](https://crocs.fi.muni.cz/) at [MUNI](https://www.muni.cz) and [University of Cagliari](https://www.unica.it/). 

[Adam Janovsky](https://github.com/adamjanovsky), adamjanovsky@mail.muni.cz is a corresponding author.