# AndroidMalwareCrypto
The analysis of cryptography in Android malicious applications. All knowledge regarding this project shall reside in the readme file if not stated otherwise.

## Install 

The project is tested on python 3.6. It should suffice to clone and install requirements. Additionally, it may be necessary to integrate with some services depending on the task. Please see [architecture](https://github.com/adamjanovsky/AndroidMalwareCrypto/tree/master#architecture) for more details.

To install, run

```
git clone https://github.com/adamjanovsky/AndroidMalwareCrypto.git &&
cd AndroidMalwareCrypto &&
pip3 install -r requirements.txt &&
python3 ./setup.py install
```

## Usage

```
androidcrypto <path_to_yaml_configuration_file> -t <optionally a base64 encoded Neptune.ml token> -a <optiionally an Androzoo API token>
```

Ultimately, what the script will perform is fully defined by the experiment config file you provide, [see Architecture](https://github.com/adamjanovsky/AndroidMalwareCrypto#architecture) or the [sample config](https://github.com/adamjanovsky/AndroidMalwareCrypto/blob/master/sample_configs/sample_config.yml) for more details.

## Architecture

The main logical unit of the project is an `experiment`. Experiment is fully defined by an experiment config, [see example](https://github.com/adamjanovsky/AndroidMalwareCrypto/blob/master/sample_configs/sample_config.yml). The experiment is able to perform four major tasks:

1. Create and download dataset of apks to work with (`download` task)
2. Decompile the apks into Androguard analysis objects (`decompile` task)
3. Analyze the usage of third-party libraries in the apk using Libradar (`third_party_libs` task)
4. Evaluate the usage of cryptographic API from the Androguard dx file (`evaluate` task)

This list also sets the chronological order of the actions, e.g. step 4 cannot be done before step 2, etc. You can choose any subset of the tasks to be performed, e.g. 1,2,3 or just 3,4. Also, task 1 can be done manually if you have your own dataset for analysis. See [how to work with datasets](https://github.com/adamjanovsky/AndroidMalwareCrypto#androzoo-integration) for more details. Some of the tasks may be associated with the external tools to run properly. Please make sure you have the integration covered according to the table below

| Task  | Tool to integrate | Can be turned off |
| ------------- | ------------- |  ------------- |
| All tasks | [Neptune.ml](https://github.com/adamjanovsky/AndroidMalwareCrypto#neptune-integration) | Yes, do not monitor |
| `download` | [Androzoo dataset](https://github.com/adamjanovsky/AndroidMalwareCrypto#androzoo-integration)  | Yes, supply your dataset |
| `decompile`  | [Patched Androguard, jadx](https://github.com/adamjanovsky/AndroidMalwareCrypto#androguard-and-jadx-integration)  | You can decompile with DAD |
| `third_party_libs` | [Literadar](https://github.com/adamjanovsky/AndroidMalwareCrypto#literadar-integration) | Simply skip the task |
| `evaluate`  | No tool needed |

The experiment works with multiple apks concurrently, performing all four tasks (or their subset) chronologically.  Each of the tasks has its own configuration options, all residing in the experiment configuration file. All results are stored in a single json file called `records.json` held in the dataset folder.

### Neptune integration

The project is meant to be fully integrated with [Neptune.ai](Neptune.ai). This allows us to track all experiments performed with the project. The `Team/Project_name` is to be supplied from the config file, whereas the personal API token is supplied as a command-line parameter. 

If you do not want to integrate with Neptune.ai, simply put `is_being_logged: False` to the experiment config and you're safe.

### Androzoo integration

The project is capable of working alongside the [Androzoo dataset](https://androzoo.uni.lu/). In order to be able to create datasets from the Androzoo database, you need to register in the Androzoo service and create your own API key. After that, you have to download the csv file of the Androzoo and shuffle the lines of it. Then, you simply provide the path to this csv file in your config (and your API token as command line parameter) and you're done, our script will automate the downloading itself. See ["How to work with datasets"](https://github.com/adamjanovsky/AndroidMalwareCrypto/tree/refactor#how-to-work-with-datasets) for supplying your own dataset instead of Androzoo. 

### Androguard and Jadx integration

We decided to use [Jadx decompiler](https://github.com/skylot/jadx) with Androguard instead of default DAD. That is because Jadx decompiler produces cleaner source code. However, current version of Androguard contains bug yet to be resolved that prevents from using Jadx. Luckily, we have a fix. Until Androguard bug is fixed in the repository, deploy your own version with this fix: https://github.com/androguard/androguard/issues/763#issuecomment-558646108 (just modify the two lines). Note that Jadx doesn't work so smoothly with Androguard which in turn costs probably 25% of performance. This shouldn't be a problem as we should still be able to decompile 2 files per second on a fast machine. Thus 100k samples get decompiled in 14 hours.

Also, you need to have [Jadx](https://github.com/skylot/jadx) installed and present in a path. You also have to setup path to your `jadx` binary in the experiment config file. [See examples](https://github.com/adamjanovsky/AndroidMalwareCrypto/tree/master/sample_configs).

### Literadar integration

Detection of third-party libraries usage uses the [Literadar](https://github.com/pkumza/LiteRadar) script under the hood. That script is being executed as python2 process, so you need to have python2 functionable as well on your computer. Make sure to specify the path to the LiteRadar binary in the experiment config. 

## How to work with datasets

You can create your dataset as a result of the Download task (requires Androzoo API key) or supply your own dataset. If you want to create your own dataset, you have to supply the APKs and the `meta.yml` file. See the [example dataset](https://github.com/adamjanovsky/AndroidMalwareCrypto/tree/master/notebooks). The file structure of the dataset folder is as follows. When the dataset is resolved internally by the script, a check for the presence of the `records.json` file is done. If not present, the file is created and is being gradually populated with results from various tasks. The folder structure of a dataset is as follows:

```
DatasetFolder/
+-- meta.yml
+-- records.json
|     +-- data/
|     +-- /apk
       |    +-- all_the_apk_files
```

## License

MIT, but should be decided when we publish it... 

